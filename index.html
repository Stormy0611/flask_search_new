<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      #buttondrugs {
       top:90%;
       left:90%;
       width:75px;
       height:40px;
       position: absolute;
       z-index: 2;
       background: orange; 
      }
    </style>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
        <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link href="https://unpkg.com/bootstrap-multiselect@0.9.13/dist/css/bootstrap-multiselect.css" rel="stylesheet"/>
    <link rel="stylesheet" href="jquery-css/amsify.suggestags.css">

    <link rel="stylesheet" href="main.css" />
    <link
      rel="stylesheet"
      href="select2.min.css"
    />

    <link rel="stylesheet" href="dist/virtual-select.min.css" />

    <script src="dist/virtual-select.min.js"></script>

    <title>Document</title>
  </head>

  <body>
    <div class="top-nav">
      <div class="logo-part">
        <img
          class="logo"
          src="https://i.ibb.co/twRDCjY/image.png"
          style="margin-right: 30px"
        />
        <div class="nav-text">
          A database of 3m articles[not yet :) ], updated every 24 hours. Last update 11 hours ago.
        </div>
      </div>
      <div class="nav-about">About</div>
    </div>

    <div class="main-content">
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Welcome to SUMO!</strong> 
        <br> This is a <a href="https://localhost/about/">Data Extraction Tool</a> for the Analytics and visualization of the information from scientific articles.
        <br><br>This tool can:
        <br>1) search articles according to attributes of interest.
        <br>2) build analytics of resulting studies: 
        <br>&emsp;- frequency of conditions
        <br>&emsp;- frequency of drugs
        <br>&emsp;- types of study design
        <br>&emsp;- types of data
        <button
          type="button"
          class="close"
          data-dismiss="alert"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      
      <div class="search-filter">

        
        <div class="example-study-design-select"></div>
        <div class="example-data-type-select"></div>
        <div class="example-drug_category-select"></div>
        <div class="example-condition_category-select"></div>
        <input type="text"class="select2" name="select2"  value="439777">
        
      </div>
      
      <div class="results-label">
        <p class="p-result"></p>
      </div>

      <!-- <img style="display:none;" id="bigpic" src="bigpic" /> !-->
      <button id="buttondrugs" onclick="showPicture()">Visualize</button>



    <div class="cards-main">
    </div>
    <div class="preload" style="display: block"><img src="http://i.imgur.com/KUJoe.gif">
    </div>


    <button class="btn btn-primary" id="loadbtn" style="margin: 5% !important;">
      Load More
      </button>

    
      
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>

    <script src="jquery-js/jquery.amsify.suggestags.js"></script>

    <script
      src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
      integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
      crossorigin="anonymous"
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.full.min.js"></script>

    <script>

      var SERVER_URL = 'http://localhost:5000';
      //var SERVER_URL = 'http://tandem7.pythonanywhere.com';
      get_study_design()
      get_data_type()
      get_drug_categories()
      get_condition_categories()

      async function get_study_design(){
       
        var response =  await fetch(SERVER_URL + "/get_study_design", {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
        });
        
        var data = await response.json();

        myOptions = []
        data.forEach(elem =>{
          myOptions.push({
            value:elem,
            label:elem
          });
        });
          VirtualSelect.init({
          ele: '.example-study-design-select',
          options: myOptions,
          multiple:true,
          showValueAsTags: true,
          searchPlaceholderText: "Search any Study Design...",
          placeholder: "Select Study Design",
          });
      }
      

      async function get_drug_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_drug_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem});
       });
         VirtualSelect.init({
         ele: '.example-drug_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Drug category...",
         placeholder:"Select Drug category"
         });
     }
        

      async function get_condition_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_condition_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-condition_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Condition category...",
         placeholder:"Select Condition category"
         });
     }
        
      async function get_data_type(){
       
       var response =  await fetch(SERVER_URL + "/get_data_type", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-data-type-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Data Type...",
         placeholder:"Select Data Type"
         });
     }
     
     async function get_study_design(){
       
        var response =  await fetch(SERVER_URL + "/get_study_design", {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
        });
        
        var data = await response.json();

        myOptions = []
        data.forEach(elem =>{
          myOptions.push({
            value:elem,
            label:elem
          });
        });
          VirtualSelect.init({
          ele: '.example-study-design-select',
          options: myOptions,
          multiple:true,
          showValueAsTags: true,
          searchPlaceholderText: "Search any Study Design...",
          placeholder: "Select Study Design"
          });
      }
      

      async function get_drug_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_drug_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem});
       });
         VirtualSelect.init({
         ele: '.example-drug_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Drug category...",
         placeholder:"Select Drug category"
         });
     }
        

      async function get_condition_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_condition_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-condition_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Condition category...",
         placeholder:"Select Condition category"
         });
     }
        
      async function get_data_type(){
       
       var response =  await fetch(SERVER_URL + "/get_data_type", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-data-type-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Data Type...",
         placeholder:"Select Data Type"
         });
     }

     flt_data = {
        'flt_mesh': [],
        'flt_sd': [],
        'flt_dt': [],
        'flt_dc': [],
        'flt_cc': []
      };
      
      function get_data() {
        $.ajax({
            type: "POST",
            url: SERVER_URL + '/get_data',
            dataType: "json",
            headers: {
              'Content-Type':'application/json'
            },
            data: JSON.stringify(flt_data),
            success: function (data) {
              console.log(data)
            },
            error: function (xhr, exception) {
                var msg = "";
                if (xhr.status === 0) {
                    msg = "Not connect.\n Verify Network." + xhr.responseText;
                } else if (xhr.status == 404) {
                    msg = "Requested page not found. [404]" + xhr.responseText;
                } else if (xhr.status == 500) {
                    msg = "Internal Server Error [500]." +  xhr.responseText;
                } else if (exception === "parsererror") {
                    msg = "Requested JSON parse failed.";
                } else if (exception === "timeout") {
                    msg = "Time out error." + xhr.responseText;
                } else if (exception === "abort") {
                    msg = "Ajax request aborted.";
                } else {
                    msg = "Error:" + xhr.status + " " + xhr.responseText;
                }
            }
        }); 
      }

      ///Filter Data -----------------------------------------------------

      $('.example-study-design-select').change(function() {
        flt_data['flt_sd'] = this.value;
        console.log(flt_data)
        //display_data(filter_study_design(this.value))
      });

      $('.example-data-type-select').change(function() {
        flt_data['flt_dt'] = this.value;
        console.log(flt_data)
        //display_data(filter_data_type(this.value))
      });

      $('.example-drug_category-select').change(function() {
        flt_data['flt_dc'] = this.value;
        console.log(flt_data)
        //display_data(filter_data_type(this.value))
      });

      $('.example-condition_category-select').change(function() {
        flt_data['flt_cc'] = this.value;
        console.log(flt_data)
        //display_data(filter_data_type(this.value))
      });

      $('input[name="select2"]').amsifySuggestags({
					suggestions: ['anemia', 'tacrolimus', 'female', 'male', 'neutropenia',
       'rituximab', 'thrombocytopenia', 'buprenorphine',
       'opioid-related disorders', 'desogestrel', 'levonorgestrel',
       'enoxaparin', 'bacteremia', 'chlorhexidine',
       'burkholderia infections', 'cisplatin', 'aged', 'carcinoma',
       'chemoradiotherapy', 'head and neck neoplasms', 'neoplasm staging',
       'squamous cell carcinoma of head and neck', 'brain neoplasms',
       'carmustine', 'combined modality therapy', 'radiosurgery',
       'kidney neoplasms', 'sunitinib', 'staphylococcus aureus',
       'carrier state', 'cross infection', 'infection control',
       'staphylococcal infections', 'febrile neutropenia', 'filgrastim',
       'pegfilgrastim', 'sargramostim', 'neoplasms', 'osteoporosis',
       'osteoporotic fractures', 'teriparatide', 'macular edema',
       'ranibizumab', 'retinal vein occlusion'],

					classes: ['bg-primary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info'],
					whiteList: false,
          type:'amsify',
          tagLimit:10,

          checkSimilar:true,
          afterAdd:  function(e){
            //console.log('here')
            start = 0;
            crds = 0;
              //console.log(e.target.value)
              //Send request to the API server for data.
              document.getElementsByClassName('cards-main')[0].innerHTML = '';
              datafound = 0;
              val = $('input[name="select2"]').val();
              //main_searched_data_ = [];
              //get_data_by_tags(val)

              //show_cards_data("anemia")
              flt_data['flt_mesh'] = $('input[name="select2"]').val();
              console.log(flt_data);
          },
          afterRemove: function(e){
            start = 0
            crds = 0
            datafound = 0
            //console.log('removed!' + e)
            document.getElementsByClassName('cards-main')[0].innerHTML = ''
            if ($('input[name="select2"]').val().length > 0){
              main_searched_data_ = []
              crds = 0
              //get_data_by_tags($('input[name="select2"]').val())
              flt_data['flt_mesh'] = $('input[name="select2"]').val()
              console.log(flt_data)
            }else{
              document.getElementById('loadbtn').textContent = "Load more"
              document.getElementById('loadbtn').disabled = true
            }
          }
          
				});

      document.getElementsByClassName('amsify-suggestags-input')[0].placeholder = "Type Concept ID / Name...";

      $('#loadbtn').click(function(){
        //get_data_by_tags($('input[name="select2"]').val())
      });

      
      function display_data(elements){

        study_design = document.querySelector('.example-study-design-select').value;
        data_type = document.querySelector('.example-data-type-select').value;
        condition_category = document.querySelector('.example-condition_category-select').value;
        drug_category = document.querySelector('.example-drug_category-select').value;

        if (study_design.length > 0 || data_type.length > 0 || condition_category.length > 0 || drug_category.length >0){
            if (study_design.length > 0){
              elements = filter_study_design(study_design)
            }
            else if (data_type.length > 0){
              elements = filter_data_type(data_type)
            }
            else if (condition_category.length > 0){
              elements = filter_condition_category(condition_category)
            }
            else if (data_type.length > 0){
              elements = filter_drug_category(drug_category)
            }
        }

        document.getElementsByClassName('p-result')[0].textContent = "Showing "+elements.length+" results"
        document.getElementsByClassName('cards-main')[0].innerHTML = ''
        console.log(elements)
        i = 0
        elements.forEach(element =>{
          abstract_data = element.abstract_data.replace("['",'').replace("']",'')
        i ++;
        document.getElementsByClassName('cards-main')[0].innerHTML += 
          `
          <div class="card card-`+i+`">
            <a style="color:black;" href="`+element.pm_link+`">
            <div class="card-top"><p class="card-top-date badge badge-primary" >`+element.journal.toString().replace("['",'').replace("']",'')+`</p></div>
        <div class="card-body">
          <h5 class="card-title">`+element.title.replace("['",'').replace("']",'')+`</h5>

          <div class="attrs">
            
            <div class="db-cols badge badge-success"><a style="color:white;"href="https://athena.ohdsi.org/search-terms/terms/`+element.concept_id_1+`">`+element.concept_id_1+`</a></div>
            <div class="db-cols badge badge-success">`+element.mesh+`</div>
            <div class="db-cols badge badge-warning">`+element.date_pub.toString().replace("['",'').replace("']",'')+`</div>
            <div class="db-cols badge badge-danger">`+element.study_design+`</div>
            <div class="db-cols badge badge-info">`+element.data_type+`</div>
            </div>
          <div>
            <p class="card-text more" style="display:none;" id='tx-more-`+i+`'>`+abstract_data+`<Button onclick="toogle('`+i+`')" style="margin:1%; border: 0.5px solid;background: white;color: black;" id="bt-`+i+`" class="badge badge-primary">See more</Button></p>
            <p class="card-text less" style="display:block;" id='tx-less-`+i+`'>`+abstract_data.toString().substring(0, abstract_data.length / 3)+`...<Button onclick="toogle('`+i+`')" style="margin:1%; border: 0.5px solid;background: white;color: black;" id="bt-`+i+`" class="badge badge-primary">See more</Button></p>
            
          </div>
            <div style="margin:1%;"><h4><strong>Short overview of the study</strong></h4></div>

            <div class="data-points" style="margin:1%;">
              
              
              <div class="point-1">
                <div class="point"><strong class= "db-cols badge badge-success">Condition </strong>`+element.condition_+`</div>
              <div class="point"><strong class="db-cols badge badge-info">Drug </strong>`+element.drug_+`</div>
              <div class="point"><strong class="db-cols badge badge-warning">Procedures </strong>`+element.procedures_+`</div>
                </div>

                <div class="point-1">
                <div class="point"><strong>Study population: </strong>Not available yet.</div>
              <div class="point"><strong>Study Design: </strong>`+element.study_design+`</div>
              <div class="point"><strong>Data Type: </strong>`+element.data_type+`</div>
              <div class="point"><strong>Sample size: </strong>Not available yet.</div>
              <div style="" class="point"><strong>Geography: </strong>Not available yet.</div>
                </div>
              
              </div>
        </div>
      </div>
      </a>
    </div>`
        })
      }      

      async function get_data_by_tags(tags) {
        main_searched_data = []
        datafound = 0
        crds = 0
        //tags = tags.split(',')

        document.getElementById('loadbtn').disabled = true
        document.getElementsByClassName('preload')[0].style.display = "block";

        study_value = document.querySelector('.example-study-design-select').value;
        data_type_value = document.querySelector('.example-data-type-select').value;
        
        
        const params = {
          tags:tags,
          start: start.toString(),
          end: "50",
          
        };

        var response = await fetch(SERVER_URL + "/fetch_by_tags", {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
          body: JSON.stringify(params),
        });
        
        var data = await response.json();
        
        
        var i = 0
        
        if (data.length == 0){
          console.log("s: "+start)
          if (start == 0){
            document.getElementById('loadbtn').textContent = "Load More"
          }else{
            document.getElementById('loadbtn').textContent = "No more available data..."
          }
          document.getElementById('loadbtn').disabled = true
        }else{
          document.getElementById('loadbtn').disabled = false
          document.getElementById('loadbtn').textContent = "Load More"
          i = start
          start += data.length;
          console.log(start)
          console.log("data:len: "+data.length)
          
        }
        
        

        
        document.getElementsByClassName('preload')[0].style.display = "none";

        data = data.filter((obj, pos, arr) => {
            return data.map(mapObj =>
                  mapObj.pmid).indexOf(obj.pmid) == pos ;
            });
        console.log(data)
        datafound = data.length
        document.getElementsByClassName('p-result')[0].textContent = "Showing "+data.length+" results"
        x_ = 0
        await data.forEach(async (element)  =>  {
          x_ ++;
          

           //drugs_elems = await get_drugs(element.pmid,element.concept_id_1)
           
           const params = {
            pmid:element.pmid,
            concept_id_1:"0"
          }
          var response = await fetch(SERVER_URL + "/fetch_drugs", {
            headers: {
              "Content-Type": "application/json",
            },
            method: "POST",
            body: JSON.stringify(params),
          });
          
          var drugs_elems = await response.json()
          main_searched_data.push(drugs_elems)
          





          const params_con = {
          pmid:element.pmid,
          concept_id_1:element.concept_id_1
        }
        var response = await fetch(SERVER_URL + "/fetch_condition", {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
          body: JSON.stringify(params_con),
        });
        
        var condition_elems = await response.json();
        const params_pro = {
          pmid:element.pmid,
          concept_id_1:element.concept_id_1
        }
        var response = await fetch(SERVER_URL + "/fetch_procedures", {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
          body: JSON.stringify(params_pro),
        });
        
        var procedures_elems = await response.json();
        
          

          drugs_elems = drugs_elems.filter((obj, pos, arr) => {
            return drugs_elems.map(mapObj =>
                  mapObj.concept_id_1).indexOf(obj.concept_id_1) == pos ;
            });

            condition_elems = condition_elems.filter((obj, pos, arr) => {
          return condition_elems.map(mapObj =>
                mapObj.concept_id_1).indexOf(obj.concept_id_1) == pos ;
          });

          procedures_elems = procedures_elems.filter((obj, pos, arr) => {
          return procedures_elems.map(mapObj =>
                mapObj.concept_id_1).indexOf(obj.concept_id_1) == pos ;
          });
          i += 1
          
          abstract_data = element.abstract.replace("['",'').replace("']",'')



          drug_ = ''
          drugs_elems.forEach(drug_el =>{
            drug_ += "<br>"+ drug_el.mesh + "<a href='https://athena.ohdsi.org/search-terms/terms/"+drug_el.concept_id_1+"'>  "+drug_el.concept_id_1 + "</a> "
          });
          condition_ = ''
          condition_elems.forEach(drug_el =>{
            condition_ += "<br>"+ drug_el.mesh + "<a href='https://athena.ohdsi.org/search-terms/terms/"+drug_el.concept_id_1+"'>  "+drug_el.concept_id_1  + "  </a> "
          });
          procedures_ = ''

          procedures_elems.forEach(drug_el =>{
            procedures_ += "<br>"+ drug_el.mesh + "<a href='https://athena.ohdsi.org/search-terms/terms/"+drug_el.concept_id_1+"'>  "+drug_el.concept_id_1  + "</a> "
          });
          searched_data = {}
          searched_data['mesh'] = element.mesh
          searched_data['pm_link'] = element.pm_link
          searched_data['journal'] = element.journal.replace("['",'').replace("']",'')
          searched_data['title'] = element.title.replace("['",'').replace("']",'')
          searched_data['concept_id_1'] = element.concept_id_1
          searched_data['concept_id_link'] = "https://athena.ohdsi.org/search-terms/terms/"+element.concept_id_1
          searched_data['date_pub'] = element.date_pub.replace("['",'').replace("']",'')
          searched_data['study_design'] = element.study_design
          searched_data['data_type'] = element.data_type
          searched_data['abstract_data'] = abstract_data
          searched_data['drug_'] = drug_
          searched_data['condition_'] = condition_
          searched_data['procedures_'] = procedures_
          
          show_cards_data(searched_data)
          
          //console.log(element)

          
          


          console.log(x_)
      
          
          
        
        });
        //console.log(main_searched_data)
        //console.log(main_searched_data)
        return "complete...."
        //console.log(main_searched_data.length)
      }

      function toogle(id){
          var bt = document.getElementById('bt-'+id)
          if (bt.textContent == "See more"){
            var tx = document.getElementById('tx-more-'+id).style.display = 'block';
            var tx = document.getElementById('tx-less-'+id).style.display = 'none'
            bt.textContent = "See less"
          }else{
            var tx = document.getElementById('tx-less-'+id).style.display = 'block'
            var tx = document.getElementById('tx-more-'+id).style.display = 'none'
            bt.textContent = "See more"
          }
      }
    </script>
  </body>
</html>
