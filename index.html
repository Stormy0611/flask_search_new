<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
        <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link href="https://unpkg.com/bootstrap-multiselect@0.9.13/dist/css/bootstrap-multiselect.css" rel="stylesheet"/>
    <link rel="stylesheet" href="jquery-css/amsify.suggestags.css">

    <link rel="stylesheet" href="main.css" />
    <link
      rel="stylesheet"
      href="select2.min.css"
    />

    <link rel="stylesheet" href="dist/virtual-select.min.css" />

    <style>
      #buttondrugs {
       top:90%;
       left:90%;
       width:75px;
       height:40px;
       position: absolute;
       z-index: 2;
       background: orange; 
      }
      /* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  position: relative;
  background-color: #fefefe;
  margin: auto;
  padding: 0;
  border: 1px solid #888;
  width: 80%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
  -webkit-animation-name: animatetop;
  -webkit-animation-duration: 0.4s;
  animation-name: animatetop;
  animation-duration: 0.4s
}

/* Add Animation */
@-webkit-keyframes animatetop {
  from {top:-300px; opacity:0} 
  to {top:0; opacity:1}
}

@keyframes animatetop {
  from {top:-300px; opacity:0}
  to {top:0; opacity:1}
}

/* The Close Button */
.close {
  color: white;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

.modal-header {
  padding: 2px 16px;
  background-color: #5cb85c;
  color: white;
}

.modal-body {padding: 2px 16px;}

.modal-footer {
  padding: 2px 16px;
  background-color: #5cb85c;
  color: white;
}
    </style>

    <script src="dist/virtual-select.min.js"></script>
    <script
    src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"
    ></script>
    <script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"
    ></script>
    <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"
    ></script>
    <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"
    ></script>
    
    <script src="jquery-js/jquery.amsify.suggestags.js"></script>
    
    <script
    src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
    integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
    crossorigin="anonymous"
    ></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.5/js/select2.full.min.js"></script>
    <script type="text/javascript" src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>
    
    <title>Document</title>
  </head>

  <body>
    <div class="top-nav">
      <div class="logo-part">
        <img
          class="logo"
          src="https://i.ibb.co/twRDCjY/image.png"
          style="margin-right: 30px"
        />
        <div class="nav-text">
          A database of 3m articles[not yet :) ], updated every 24 hours. Last update 11 hours ago.
        </div>
      </div>
      <div class="nav-about">About</div>
    </div>

    <div class="main-content">
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Welcome to SUMO!</strong> 
        <br> This is a <a href="https://localhost/about/">Data Extraction Tool</a> for the Analytics and visualization of the information from scientific articles.
        <br><br>This tool can:
        <br>1) search articles according to attributes of interest.
        <br>2) build analytics of resulting studies: 
        <br>&emsp;- frequency of conditions
        <br>&emsp;- frequency of drugs
        <br>&emsp;- types of study design
        <br>&emsp;- types of data
        <button
          type="button"
          class="close"
          data-dismiss="alert"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      
      <div class="search-filter">

        
        <div class="example-study-design-select"></div>
        <div class="example-data-type-select"></div>
        <!--<div class="example-drug_category-select"></div>
        <div class="example-condition_category-select"></div>!-->
        <input type="text"class="select2" name="select2" value="439777">
        
      </div>
      
      <div class="results-label">
        <p class="p-result"></p>
      </div>

      <!-- <img style="display:none;" id="bigpic" src="bigpic" /> !-->
      <button id="buttondrugs" >Visualize</button>



    <div class="cards-main">
    </div>
    <div class="preload"><img src="http://i.imgur.com/KUJoe.gif">
    </div>


    <button class="btn btn-primary" id="loadbtn" style="margin: 5% !important;">
      Load More
      </button>

<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header">
      <h2>Frequency Plots</h2>
    </div>
    <div class="modal-body" style="height: 500px">
      <div id="chartContainer" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
    </div>
    <div class="modal-footer">
      <h3></h3>
    </div>
  </div>

</div>
    
<script>

      var SERVER_URL = 'http://localhost:5000';
      //var SERVER_URL = 'http://tandem7.pythonanywhere.com';
      var res = {}
      get_study_design()
      get_data_type()
      //get_drug_categories()
      //get_condition_categories()


      async function get_study_design(){
       
        var response =  await fetch(SERVER_URL + "/get_study_design", 
        {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
        });
        
        var data = await response.json();

        myOptions = []
        data.forEach(elem =>{
          myOptions.push({
            value:elem,
            label:elem
          });
        });
          VirtualSelect.init({
          ele: '.example-study-design-select',
          options: myOptions,
          multiple:true,
          showValueAsTags: true,
          searchPlaceholderText: "Search any Study Design...",
          placeholder: "Select Study Design",
          });
      }
      

      async function get_drug_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_drug_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem});
       });
         VirtualSelect.init({
         ele: '.example-drug_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Drug category...",
         placeholder:"Select Drug category"
         });
     }
        

      async function get_condition_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_condition_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-condition_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Condition category...",
         placeholder:"Select Condition category"
         });
     }
        
      async function get_data_type(){
       
       var response =  await fetch(SERVER_URL + "/get_data_type", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-data-type-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Data Type...",
         placeholder:"Select Data Type"
         });
     }
     
     async function get_study_design(){
       
        var response =  await fetch(SERVER_URL + "/get_study_design", {
          headers: {
            "Content-Type": "application/json",
          },
          method: "POST",
        });
        
        var data = await response.json();

        myOptions = []
        data.forEach(elem =>{
          myOptions.push({
            value:elem,
            label:elem
          });
        });
          VirtualSelect.init({
          ele: '.example-study-design-select',
          options: myOptions,
          multiple:true,
          showValueAsTags: true,
          searchPlaceholderText: "Search any Study Design...",
          placeholder: "Select Study Design"
          });
      }
      

      async function get_drug_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_drug_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem});
       });
         VirtualSelect.init({
         ele: '.example-drug_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Drug category...",
         placeholder:"Select Drug category"
         });
     }
        

      async function get_condition_categories(){
       
       var response =  await fetch(SERVER_URL + "/get_condition_categories", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-condition_category-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Condition category...",
         placeholder:"Select Condition category"
         });
     }
        
      async function get_data_type(){
       
       var response =  await fetch(SERVER_URL + "/get_data_type", {
         headers: {
           "Content-Type": "application/json",
         },
         method: "POST",
         
       });
       
       var data = await response.json();

       myOptions = []
       data.forEach(elem =>{
         myOptions.push({
          value:elem,
          label:elem
        });
       });
         VirtualSelect.init({
         ele: '.example-data-type-select',
         options: myOptions,
         multiple:true,
         showValueAsTags: true,
         searchPlaceholderText:"Search any Data Type...",
         placeholder:"Select Data Type"
         });
     }

     flt_data = {
        'flt_mesh': [],
        'flt_sd': [],
        'flt_dt': [],
        'flt_limit': 3
      };
      

      function get_data() {
        $.ajax(SERVER_URL + '/get_data', {
            type: "POST",
            data: JSON.stringify(flt_data),
            headers: {
              "Content-Type": "application/json",
            },
            beforeSend: function() {
            // setting a timeout
              document.getElementsByClassName('preload')[0].style.display = "block"
            },
            success: function (data) {
              res = data
              if (res.length){
                $("#buttondrugs").attr("disabled", false);
                $("#loadbtn").attr("disabled", false);
              }
              else{
                $("#buttondrugs").attr("disabled", true);
                $("#loadbtn").attr("disabled", true);
              }
              display_data(res)
            },
            error: function (xhr, exception) {
                var msg = "";
                if (xhr.status === 0) {
                    msg = "Not connect.\n Verify Network." + xhr.responseText;
                } else if (xhr.status == 404) {
                    msg = "Requested page not found. [404]" + xhr.responseText;
                } else if (xhr.status == 500) {
                    msg = "Internal Server Error [500]." +  xhr.responseText;
                } else if (exception === "parsererror") {
                    msg = "Requested JSON parse failed.";
                } else if (exception === "timeout") {
                    msg = "Time out error." + xhr.responseText;
                } else if (exception === "abort") {
                    msg = "Ajax request aborted.";
                } else {
                    msg = "Error:" + xhr.status + " " + xhr.responseText;
                }
            }
        }); 
      }

      ///Filter Data -----------------------------------------------------

      $('.example-study-design-select').change(function() {
        flt_data['flt_sd'] = this.value;
        console.log(flt_data)
        get_data()
        
        //display_data(filter_study_design(this.value))
      });

      $('.example-data-type-select').change(function() {
        flt_data['flt_dt'] = this.value;
        console.log(flt_data)
        get_data()
        
        //display_data(filter_data_type(this.value))
      });
      /*
      $('.example-drug_category-select').change(function() {
        flt_data['flt_dc'] = this.value;
        console.log(flt_data)
        get_data()
        //display_data(filter_data_type(this.value))
      });

      
      $('.example-condition_category-select').change(function() {
        flt_data['flt_cc'] = this.value;
        console.log(flt_data)
        get_data()
        //display_data(filter_data_type(this.value))
      });
      */

      $('input[name="select2"]').amsifySuggestags({
					suggestions: ['anemia', 'tacrolimus', 'female', 'male', 'neutropenia',
       'rituximab', 'thrombocytopenia', 'buprenorphine',
       'opioid-related disorders', 'desogestrel', 'levonorgestrel',
       'enoxaparin', 'bacteremia', 'chlorhexidine',
       'burkholderia infections', 'cisplatin', 'aged', 'carcinoma',
       'chemoradiotherapy', 'head and neck neoplasms', 'neoplasm staging',
       'squamous cell carcinoma of head and neck', 'brain neoplasms',
       'carmustine', 'combined modality therapy', 'radiosurgery',
       'kidney neoplasms', 'sunitinib', 'staphylococcus aureus',
       'carrier state', 'cross infection', 'infection control',
       'staphylococcal infections', 'febrile neutropenia', 'filgrastim',
       'pegfilgrastim', 'sargramostim', 'neoplasms', 'osteoporosis',
       'osteoporotic fractures', 'teriparatide', 'macular edema',
       'ranibizumab', 'retinal vein occlusion'],

					classes: ['bg-primary', 'bg-success', 'bg-danger', 'bg-warning', 'bg-info'],
					whiteList: false,
          type:'amsify',
          tagLimit:10,

          checkSimilar:true,
          afterAdd:  function(e){
            //console.log('here')
            start = 0;
            crds = 0;
              //console.log(e.target.value)
              //Send request to the API server for data.
              document.getElementsByClassName('cards-main')[0].innerHTML = '';
              datafound = 0;
              val = $('input[name="select2"]').val();
              //main_searched_data_ = [];
              //get_data_by_tags(val)

              //show_cards_data("anemia")
              flt_data['flt_mesh'] = $('input[name="select2"]').val();
              console.log(flt_data);
              get_data()
              
          },
          afterRemove: function(e){
            start = 0
            crds = 0
            datafound = 0
            //console.log('removed!' + e)
            document.getElementsByClassName('cards-main')[0].innerHTML = ''
            flt_data['flt_mesh'] = $('input[name="select2"]').val()
            console.log(flt_data)
            get_data()
          }
          
				});

      document.getElementsByClassName('amsify-suggestags-input')[0].placeholder = "Type Concept ID / Name...";
      btn_text = {
        0: "Load less",
        3: "Load more"
      }
      $('#loadbtn').click(function(){
        if (res.length) {
          flt_data['flt_limit'] = 3 - flt_data['flt_limit']
          display_data(res)
            document.getElementById('loadbtn').textContent = btn_text[flt_data['flt_limit']]
          //get_data_by_tags($('input[name="select2"]').val())
        }
      });

      function display_data(elements){

        document.getElementsByClassName('p-result')[0].textContent = "Showing "+elements.length+" results"
        document.getElementsByClassName('cards-main')[0].innerHTML = ''
        console.log(elements)
        if (flt_data['flt_limit'] && elements.length)
          lmt = flt_data['flt_limit']
        else
          lmt = elements.length
        for (i = 0; i < lmt - 1; i++){
          element = elements[i]
            document.getElementsByClassName('cards-main')[0].innerHTML += 
          `
          <div class="card card-`+i+`">
            <a style="color:black;" href="`+element['pm_link']+`" target="_blank">
            <div class="card-top"><p class="card-top-date badge badge-primary" >`+element['journal']+`</p></div>
        <div class="card-body">
          <h5 class="card-title">`+element['title']+`</h5>

          <div class="attrs">
            
            <div class="db-cols badge badge-success"><a style="color:white;"href="https://athena.ohdsi.org/search-terms/terms/`+element['concept_id']+`">`+element['concept_id']+`</a></div>
            <div class="db-cols badge badge-success">`+element['mesh']+`</div>
            <div class="db-cols badge badge-warning">`+element['date_pub']+`</div>
            <div class="db-cols badge badge-danger">`+element['study_design']+`</div>
            <div class="db-cols badge badge-info">`+element['data_type']+`</div>
            </div>
          <div>
            <p class="card-text more" style="display:none;" id='tx-more-`+i+`'>`+element['abstract']+`<Button onclick="toogle('`+i+`')" style="margin:1%; border: 0.5px solid;background: white;color: black;" id="bt-`+i+`" class="badge badge-primary">See more</Button></p>
            <p class="card-text less" style="display:block;" id='tx-less-`+i+`'>`+element['abstract']+`...<Button onclick="toogle('`+i+`')" style="margin:1%; border: 0.5px solid;background: white;color: black;" id="bt-`+i+`" class="badge badge-primary">See more</Button></p>
            
          </div>
            <div style="margin:1%;"><h4><strong>Short overview of the study</strong></h4></div>

            <div class="data-points" style="margin:1%;">
              
              <div class="point-1">
                <div class="point"><strong class= "db-cols badge badge-success">`+element['domain']+`</strong>`+element['domain']+`</div>
                <!--
              <div class="point"><strong class="db-cols badge badge-info">Drug </strong>`+element.drug_+`</div>
              <div class="point"><strong class="db-cols badge badge-warning">Procedures </strong>`+element.procedures_+`</div>
                </div>
                !-->
                <div class="point-1">
                <div class="point"><strong>Study population: </strong>Not available yet.</div>
              <div class="point"><strong>Study Design: </strong>`+element['study_design']+`</div>
              <div class="point"><strong>Data Type: </strong>`+element['data_type']+`</div>
              <div class="point"><strong>Sample size: </strong>Not available yet.</div>
              <div style="" class="point"><strong>Geography: </strong>Not available yet.</div>
                </div>
              
              </div>
        </div>
      </div>
      </a>
    </div>`
        }
        document.getElementsByClassName('preload')[0].style.display = "none"
        
      }   

      function toogle(id){
          var bt = document.getElementById('bt-'+id)
          if (bt.textContent == "See more"){
            var tx = document.getElementById('tx-more-'+id).style.display = 'block';
            var tx = document.getElementById('tx-less-'+id).style.display = 'none'
            bt.textContent = "See less"
          }else{
            var tx = document.getElementById('tx-less-'+id).style.display = 'block'
            var tx = document.getElementById('tx-more-'+id).style.display = 'none'
            bt.textContent = "See more"
          }
      }

      // Get the modal
var modal = document.getElementById("myModal");

// Get the button that opens the modal
var btn = document.getElementById("buttondrugs");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close");

// When the user clicks the button, open the modal 
btn.onclick = function() {
  var condition_frequency = (res[res.length - 1]['n_mesh_contition'] * 100 / (res.length - 1)).toString().split('.')[0]
  var drug_frequency = (res[res.length - 1]['n_mesh_drug'] * 100 / (res.length - 1)).toString().split('.')[0]
  var options = {
	animationEnabled: true,
	title: {
		text: "Condition and Drug Frequency",                
		fontColor: "Peru"
	},	
	axisY: {
		tickThickness: 0,
		lineThickness: 0,
		valueFormatString: " ",
		gridThickness: 0                    
	},
	axisX: {
		tickThickness: 0,
		lineThickness: 0,
		labelFontSize: 18,
		labelFontColor: "Peru"				
	},
	data: [{
		indexLabelFontSize: 26,
		toolTipContent: "<span style=\"color:#62C9C3\">{indexLabel}:</span> <span style=\"color:#CD853F\"><strong>{y}</strong></span>",
		indexLabelPlacement: "inside",
		indexLabelFontColor: "purple",
		indexLabelFontWeight: 600,
		indexLabelFontFamily: "Verdana",
		color: "#62C9C3",
		type: "bar",
		dataPoints: [
			{ y: parseInt(condition_frequency), label: condition_frequency + "%", indexLabel: "Condition" },
			{ y: parseInt(drug_frequency), label: drug_frequency + "%", indexLabel: "Drug" },
			{ y: 100, label: "100%", indexLabel: "" }
		]
	}]
};
$("#chartContainer").CanvasJSChart(options);
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
    </script>
  </body>
</html>
